@page "/admin/users"
@layout Client.Layout.MainLayout
@using EduMentorClient.Services
@using System.Net.Http.Headers
@inject HttpClient Http
@inject UserState UserState
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Gestão de Usuários - Admin</PageTitle>

<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-end mb-6">
        <div>
            <h1 class="text-3xl font-extrabold text-[#0056D2]">Gestão de Usuários</h1>
            <p class="text-sm text-gray-500 mt-1">Administração total da base de dados.</p>
        </div>
        <span class="text-xs font-medium bg-blue-50 text-blue-600 px-2 py-1 rounded-full">
            Total: @users.Count
        </span>
    </div>

    @if (loading)
    {
        <div class="flex justify-center mt-12">
            <div class="animate-spin h-8 w-8 border-4 border-[#0056D2] rounded-full border-t-transparent"></div>
        </div>
    }
    else
    {
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr>
                        <th class="py-4 px-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200">ID</th>
                        <th class="py-4 px-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200">Nome</th>
                        <th class="py-4 px-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200">Email</th>
                        <th class="py-4 px-4 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200">Perfil</th>
                        <th class="py-4 px-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right border-b border-gray-200">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr class="hover:bg-gray-50 transition duration-150 border-b border-gray-200 last:border-b-0">
                            <td class="py-4 px-4 text-sm text-gray-400 font-mono">#@user.Id</td>
                            <td class="py-4 px-4 text-sm font-semibold text-gray-900">@user.Name</td>
                            <td class="py-4 px-4 text-sm text-gray-600">@user.Email</td>
                            <td class="py-4 px-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    @(user.Role == "Admin" ? "bg-red-50 text-red-700 border border-red-100" : 
                                      user.Role == "Mentor" ? "bg-purple-50 text-purple-700 border border-purple-100" : 
                                      "bg-green-50 text-green-700 border border-green-100")">
                                    @user.Role
                                </span>
                            </td>
                            <td class="py-4 px-4 text-right text-sm">
                                @if (user.Role != "Admin")
                                {
                                    <button @onclick="() => DeleteUser(user)" class="text-gray-400 hover:text-red-600 font-medium transition flex items-center justify-end gap-1 ml-auto">Excluir</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private bool loading = true;
    private List<UserDto> users = new();

    protected override async Task OnInitializedAsync()
    {
        if (!UserState.IsLoggedIn || UserState.Role != "Admin")
        {
            Nav.NavigateTo("/login");
            return;
        }
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        loading = true;
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, "api/user");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", UserState.Token);
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
                users = await response.Content.ReadFromJsonAsync<List<UserDto>>() ?? new();
        }
        catch { Snackbar.Add("Erro ao carregar usuários.", Severity.Error); }
        finally { loading = false; }
    }

    private async Task DeleteUser(UserDto user)
    {
        bool confirm = await JS.InvokeAsync<bool>("confirm", $"Tem certeza que deseja excluir {user.Name}?");
        
        if (!confirm) return;
        
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Delete, $"api/user/{user.Id}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", UserState.Token);
            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Usuário excluído.", Severity.Success);
                await LoadUsers();
            }
            else 
            {
                Snackbar.Add("Erro ao excluir.", Severity.Error);
            }
        }
        catch 
        { 
            Snackbar.Add("Erro de conexão.", Severity.Error); 
        }
    }

    public class UserDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }
}