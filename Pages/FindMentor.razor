@page "/find-mentors"
@using EduMentorClient.Services
@using System.Net.Http.Headers
@using System.Text.Json 
@inject HttpClient Http
@inject UserState UserState
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Encontrar Mentores - EduMentor</PageTitle>

<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <div class="text-center mb-10">
        <h1 class="text-3xl font-extrabold text-[#0056D2] tracking-tight sm:text-4xl">
            Encontrar Mentores
        </h1>
        <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500">
            Conecte-se com especialistas para acelerar seu aprendizado.
        </p>
    </div>

    <div class="max-w-3xl mx-auto mb-10">
        <div class="relative flex items-center shadow-sm rounded-full bg-white border border-gray-300 focus-within:ring-2 focus-within:ring-[#0056D2] focus-within:border-[#0056D2]">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
            </div>
            <input type="text" 
                   @bind="searchArea" 
                   @onkeydown="@Enter"
                   class="block w-full pl-12 pr-4 py-4 rounded-l-full text-gray-900 placeholder-gray-500 focus:outline-none sm:text-sm border-none" 
                   placeholder="Filtrar por Área (Ex: Tecnologia, Saúde...)" />
            
            <button @onclick="Search" 
                    class="mr-1 py-2 px-6 bg-[#0056D2] hover:bg-[#00419E] text-white font-bold rounded-full transition duration-200">
                Buscar
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="flex justify-center mt-12">
            <svg class="animate-spin h-10 w-10 text-[#0056D2]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    }
    else if (pagedResult?.Items == null || !pagedResult.Items.Any())
    {
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum mentor encontrado</h3>
            <p class="mt-1 text-sm text-gray-500">Tente buscar por outra área de interesse.</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            @foreach (var mentor in pagedResult.Items)
            {
                <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-200 hover:shadow-lg transition duration-300 flex flex-col h-full">
                    <div class="p-6 flex-grow">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <span class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center text-[#0056D2] font-bold text-xl">
                                    @(string.IsNullOrEmpty(mentor.Name) ? "?" : mentor.Name.Substring(0, 1).ToUpper())
                                </span>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-bold text-gray-900 truncate w-40" title="@mentor.Name">@mentor.Name</h3>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-800 mt-1">
                                    @mentor.AreaInteresse
                                </span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600 line-clamp-3">
                                @(string.IsNullOrEmpty(mentor.Bio) ? "Este mentor ainda não adicionou uma biografia." : mentor.Bio)
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100">
                        @if (mentor.MentorshipId > 0)
                        {
                            <div class="flex gap-2">
                                <button disabled
                                        class="flex-1 flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-500 bg-gray-200 cursor-not-allowed">
                                    <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Pendente/Ativo
                                </button>

                                <button @onclick="() => CancelMentorship(mentor)"
                                        title="Cancelar solicitação/vínculo"
                                        class="flex-shrink-0 flex justify-center items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600 focus:outline-none transition shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        }
                        else
                        {
                            <button @onclick="() => OpenModal(mentor)"
                                    class="w-full flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-[#0056D2] hover:bg-[#00419E] focus:outline-none transition shadow-sm">
                                <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                </svg>
                                Solicitar Mentoria
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="flex justify-center items-center mt-10 gap-4 pb-8">
            <button @onclick="PreviousPage" disabled="@(!pagedResult.HasPrevious)"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Anterior
            </button>
            
            <span class="text-sm text-gray-600 font-medium">
                Página @pagedResult.CurrentPage de @pagedResult.TotalPages
            </span>

            <button @onclick="NextPage" disabled="@(!pagedResult.HasNext)"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Próxima
            </button>
        </div>
    }
</div>

@if (isModalOpen && selectedMentor != null)
{
    <div class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" @onclick="CloseModal"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Conectar com @selectedMentor.Name
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 mb-4">
                                    Envie uma mensagem curta explicando o teu objetivo para iniciar a conversa.
                                </p>
                                <textarea @bind="requestMessage"
                                          rows="4"
                                          class="shadow-sm focus:ring-[#0056D2] focus:border-[#0056D2] block w-full sm:text-sm border-gray-300 rounded-md p-2 border resize-none"
                                          placeholder="Olá, gostaria de mentoria na área de..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @onclick="SendRequest"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#0056D2] text-base font-medium text-white hover:bg-[#00419E] focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition">
                        Enviar Solicitação
                    </button>
                    <button type="button" @onclick="CloseModal"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool loading = true;
    private string searchArea = "";
    
    // Paginação
    private int currentPage = 1;
    private int pageSize = 9;
    private PagedResult<MentorDto>? pagedResult;

    // Modal
    private bool isModalOpen = false;
    private MentorDto? selectedMentor;
    private string requestMessage = "";

    protected override async Task OnInitializedAsync()
    {
        if (!UserState.IsLoggedIn) { Nav.NavigateTo("/login"); return; }
        await LoadMentors();
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Search();
        }
    }

    private async Task Search()
    {
        currentPage = 1;
        await LoadMentors();
    }

    private async Task LoadMentors()
    {
        loading = true;
        try
        {
            var url = $"api/mentorship/mentors?page={currentPage}&pageSize={pageSize}";
            if (!string.IsNullOrWhiteSpace(searchArea))
            {
                url += $"&area={searchArea}";
            }

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", UserState.Token);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                pagedResult = await response.Content.ReadFromJsonAsync<PagedResult<MentorDto>>(options);
            }
            else
            {
                Snackbar.Add("Erro ao buscar mentores.", Severity.Error);
            }
        }
        catch (Exception ex) { Snackbar.Add($"Erro: {ex.Message}", Severity.Error); }
        finally { loading = false; }
    }
    
    private async Task NextPage()
    {
        if (pagedResult != null && pagedResult.HasNext)
        {
            currentPage++;
            await LoadMentors();
        }
    }

    private async Task PreviousPage()
    {
        if (pagedResult != null && pagedResult.HasPrevious)
        {
            currentPage--;
            await LoadMentors();
        }
    }

    // --- Métodos do Modal e Ações ---
    private void OpenModal(MentorDto mentor)
    {
        selectedMentor = mentor;
        requestMessage = ""; 
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
        selectedMentor = null;
    }

    private async Task SendRequest()
    {
        if (selectedMentor == null) return;
        if (string.IsNullOrWhiteSpace(requestMessage))
        {
            Snackbar.Add("Escreva uma mensagem para o mentor.", Severity.Warning);
            return;
        }

        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, $"api/mentorship/request/{selectedMentor.Id}");
            request.Content = JsonContent.Create(requestMessage);
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", UserState.Token);

            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Solicitação enviada com sucesso!", Severity.Success);
                // Atualiza a UI localmente para não precisar recarregar tudo
                // Mas como não temos o ID da nova conexão aqui, o ideal é recarregar a lista
                // ou assumir um ID temporário > 0 para bloquear o botão
                selectedMentor.MentorshipId = 999; // Temporário só para atualizar o botão
                CloseModal();
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                if (errorMsg.Contains("já tem uma conexão"))
                    Snackbar.Add("Já solicitou mentoria a este mentor.", Severity.Warning);
                else
                    Snackbar.Add("Erro ao enviar solicitação.", Severity.Error);
            }
        }
        catch { Snackbar.Add("Erro de conexão.", Severity.Error); }
    }

    private async Task CancelMentorship(MentorDto mentor)
    {
        // Se não tivermos IJSRuntime injetado no topo, adicione: @inject IJSRuntime JS
        // bool confirm = await JS.InvokeAsync<bool>("confirm", ...); 
        // Para simplificar se não tiver JS, usamos confirmação direta ou Snackbar
        
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Delete, $"api/mentorship/{mentor.MentorshipId}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", UserState.Token);

            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Vínculo cancelado.", Severity.Success);
                mentor.MentorshipId = 0; // Reseta para liberar o botão de solicitar
            }
            else
            {
                Snackbar.Add("Erro ao cancelar.", Severity.Error);
            }
        }
        catch { Snackbar.Add("Erro de conexão.", Severity.Error); }
    }

    // DTOs
    public class PagedResult<T>
    {
        public List<T> Items { get; set; } = new();
        public int TotalCount { get; set; }
        public int CurrentPage { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
        public bool HasNext => CurrentPage < TotalPages;
        public bool HasPrevious => CurrentPage > 1;
    }

    public class MentorDto
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string AreaInteresse { get; set; }
        public string Bio { get; set; }
        public int MentorshipId { get; set; } // > 0 se conectado
    }
}