@page "/login"
@using EduMentorClient.Services
@using Blazored.LocalStorage
@inject HttpClient Http
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject UserState UserState
@inject ILocalStorageService LocalStorage

<PageTitle>Login - EduMentor</PageTitle>

<MudGrid Class="d-flex justify-center align-center" Style="height: 100vh;">
    <MudItem xs="12" sm="8" md="5" lg="4">
        <MudCard Elevation="4" Class="pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary" Class="mb-2">Bem-vindo</MudText>
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">Entre na plataforma EduMentor</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudForm @ref="form">
                    <MudTextField T="string" Label="E-mail" @bind-Value="email" 
                                  InputType="InputType.Email" 
                                  Variant="Variant.Outlined" 
                                  Required="true" 
                                  Adornment="Adornment.End" 
                                  AdornmentIcon="@Icons.Material.Filled.Email" />
                    
                    <MudTextField T="string" Label="Senha" @bind-Value="password" 
                                  Variant="Variant.Outlined" 
                                  InputType="@passwordInput" 
                                  Adornment="Adornment.End" 
                                  AdornmentIcon="@passwordIcon" 
                                  OnAdornmentClick="TogglePasswordVisibility" 
                                  Required="true" 
                                  Class="mt-4"/>
                </MudForm>
            </MudCardContent>
            <MudCardActions Class="d-flex justify-center flex-column pa-4">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large" 
                           FullWidth="true" 
                           OnClick="FazerLogin" 
                           Disabled="@loading">
                    @if (loading) { <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/> <span class="ms-2">Entrando...</span> }
                    else { <span>Entrar</span> }
                </MudButton>
                
                <MudLink Href="/register" Class="mt-4">Não tem conta? Cadastre-se</MudLink>
            </MudCardActions>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    string email = "";
    string password = "";
    bool loading = false;
    MudForm form;
    
    // Configurações visuais da senha
    bool isPasswordVisible = false;
    InputType passwordInput = InputType.Password;
    string passwordIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        if (isPasswordVisible)
        {
            isPasswordVisible = false;
            passwordIcon = Icons.Material.Filled.VisibilityOff;
            passwordInput = InputType.Password;
        }
        else
        {
            isPasswordVisible = true;
            passwordIcon = Icons.Material.Filled.Visibility;
            passwordInput = InputType.Text;
        }
    }

    // Modelo da resposta da API (agora inclui o Token)
    public class LoginResponse
    {
        public string Message { get; set; }
        public int UserId { get; set; }
        public string Role { get; set; }
        public string Token { get; set; } 
    }

    private async Task FazerLogin()
    {
        await form.Validate();
        if (!form.IsValid) return;

        loading = true;
        try
        {
            var loginDto = new { Email = email, Password = password };
            
            // Chama a API
            var response = await Http.PostAsJsonAsync("api/auth/login", loginDto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                
                // 1. Atualiza Estado em Memória (Para uso imediato)
                UserState.UserId = result.UserId;
                UserState.Role = result.Role;
                UserState.Token = result.Token;
                
                // 2. Salva no Navegador (Para sobreviver ao F5)
                await LocalStorage.SetItemAsync("authToken", result.Token);
                await LocalStorage.SetItemAsync("userId", result.UserId);
                
                Snackbar.Add("Login realizado com sucesso!", Severity.Success);
                Nav.NavigateTo("/");
            }
            else
            {
                Snackbar.Add("E-mail ou senha inválidos.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro de conexão: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }
}