@page "/progress"
@using EduMentorClient.Services
@using System.Net.Http.Headers
@inject HttpClient Http
@inject UserState UserState
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<PageTitle>EduMentor - Meu Progresso</PageTitle>

<MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true" Color="Color.Primary">
    Painel de Progresso
</MudText>
<MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-8">
    Acompanhe sua evolução nas trilhas e mentorias.
</MudText>

@if (loading)
{
    <div class="d-flex justify-center mt-8">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    </div>
}
else if (report == null)
{
    <MudAlert Severity="Severity.Info" Class="mt-4">
        Não foi possível carregar os dados de progresso. Tente novamente mais tarde.
    </MudAlert>
}
else
{
    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="4" Class="pa-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Visão Geral</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.EmojiEvents">
                            @report.GlobalCompletionRate.ToString("F0")% Concluído
                        </MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.h6">Atividades de Estudo</MudText>
                            <MudText Typo="Typo.body1">
                                <b>@report.CompletedActivities</b> de <b>@report.TotalActivities</b> concluídas
                            </MudText>
                            <MudProgressLinear Color="Color.Primary" Size="Size.Large" Value="@report.GlobalCompletionRate" Class="my-2" Striped="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.h6">Sessões de Mentoria</MudText>
                            <MudText Typo="Typo.body1">
                                <b>@report.CompletedMentoringSessions</b> de <b>@report.TotalMentoringSessions</b> realizadas
                            </MudText>
                            <MudProgressLinear Color="Color.Secondary" Size="Size.Large" 
                                               Value="@(report.TotalMentoringSessions > 0 ? (double)report.CompletedMentoringSessions/report.TotalMentoringSessions*100 : 0)" 
                                               Class="my-2" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mt-4 mb-2">Detalhes por Trilha</MudText>
        </MudItem>

        @if (report.Tracks == null || !report.Tracks.Any())
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning">Você ainda não possui trilhas de estudo geradas.</MudAlert>
            </MudItem>
        }
        else
        {
            @foreach (var track in report.Tracks)
            {
                <MudItem xs="12" md="6">
                    <MudCard Elevation="3">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@track.Title</MudText>
                                <MudText Typo="Typo.caption">Status: @track.Status</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Primary" Href="/" Title="Ir para trilhas" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <div class="d-flex justify-space-between mb-2">
                                <MudText>Progresso</MudText>
                                <MudText>@track.CompletionRate.ToString("F0")%</MudText>
                            </div>
                            <MudProgressLinear Color="@GetColor(track.CompletionRate)" Value="@track.CompletionRate" Class="my-2" />
                            <MudText Typo="Typo.body2" Class="mt-2">
                                @track.CompletedActivities / @track.TotalActivities atividades
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        }
    </MudGrid>
}

@code {
    private bool loading = true;
    private StudentProgressDto? report;

    protected override async Task OnInitializedAsync()
    {
        if (!UserState.IsLoggedIn)
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"api/reports/progress/{UserState.UserId}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", UserState.Token);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                report = await response.Content.ReadFromJsonAsync<StudentProgressDto>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine(error);
                Snackbar.Add($"Erro ao carregar dados: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro de conexão: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private Color GetColor(double rate)
    {
        if (rate >= 100) return Color.Success;
        if (rate >= 50) return Color.Info;
        return Color.Warning;
    }

    public class StudentProgressDto
    {
        public int StudentId { get; set; }
        public string StudentName { get; set; }
        public int TotalActivities { get; set; }
        public int CompletedActivities { get; set; }
        public double GlobalCompletionRate { get; set; }
        public int TotalMentoringSessions { get; set; }
        public int CompletedMentoringSessions { get; set; }
        public List<TrackProgressDto> Tracks { get; set; }
    }

    public class TrackProgressDto
    {
        public int TrackId { get; set; }
        public string Title { get; set; }
        public int TotalActivities { get; set; }
        public int CompletedActivities { get; set; }
        public double CompletionRate { get; set; }
        public string Status { get; set; }
    }
}